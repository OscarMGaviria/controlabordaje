<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e3c72">
    <title>Admin Embarcaciones - Mobile</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            position: relative;
        }

        /* PWA Styles */
        .pwa-install {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 215, 0, 0.95);
            color: #000;
            padding: 12px 20px;
            border-radius: 25px;
            font-weight: bold;
            border: none;
            cursor: pointer;
            z-index: 1001;
            display: none;
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Login Styles */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            height: 100dvh;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .login-form {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 40px 30px;
            border-radius: 20px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            width: 100%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .login-title {
            color: #FFD700;
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .login-input {
            width: 100%;
            padding: 18px;
            margin: 12px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .login-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .login-input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            transform: scale(1.02);
        }

        .login-button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .login-button:active {
            transform: scale(0.98);
            box-shadow: 0 2px 10px rgba(255, 215, 0, 0.4);
        }

        .login-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .login-error {
            color: #ff6b6b;
            margin-top: 15px;
            font-size: 14px;
            background: rgba(255, 107, 107, 0.1);
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        .loading {
            display: none;
            color: #FFD700;
            margin-top: 15px;
            font-size: 16px;
        }

        /* Main App Styles */
        .admin-container {
            display: none;
            min-height: 100vh;
            min-height: 100dvh;
            flex-direction: column;
        }

        .mobile-header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            background: #FFD700;
            color: #000;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
        }

        .header-text {
            color: #FFD700;
            font-size: 18px;
            font-weight: bold;
        }

        .logout-button {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .logout-button:active {
            background: #ff6b6b;
            color: #fff;
            transform: scale(0.95);
        }

        /* Navigation Tabs */
        .nav-tabs {
            background: rgba(255, 255, 255, 0.05);
            padding: 15px 20px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .tabs-container {
            display: flex;
            gap: 12px;
            min-width: max-content;
        }

        .tab-button {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 25px;
            color: #fff;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            white-space: nowrap;
            min-width: 100px;
            text-align: center;
            touch-action: manipulation;
        }

        .tab-button:active {
            transform: scale(0.95);
        }

        .tab-button.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #000;
            border-color: #FFD700;
            transform: scale(1.05);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .vessels-title {
            color: #FFD700;
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }

        .vessel-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .vessel-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.15);
        }

        .vessel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .vessel-name {
            color: #fff;
            font-size: 20px;
            font-weight: bold;
        }

        .vessel-position {
            background: #FFD700;
            color: #000;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .vessel-status {
            text-align: center;
            margin-bottom: 20px;
        }

        .current-status {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
        }

        .status-en-turno { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .status-embarcando { background: rgba(0, 102, 255, 0.3); color: #0066ff; }
        .status-suspendido { background: rgba(255, 68, 68, 0.3); color: #ff4444; }

        .status-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .status-button {
            padding: 15px 10px;
            border: 2px solid;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: all 0.3s ease;
            text-align: center;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .status-button:active {
            transform: scale(0.95);
        }

        .status-button:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .status-button:active:before {
            width: 200px;
            height: 200px;
        }

        .btn-en-turno {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border-color: #fff;
        }

        .btn-en-turno.active {
            background: #fff;
            color: #000;
        }

        .btn-embarcando {
            background: rgba(0, 102, 255, 0.2);
            color: #0066ff;
            border-color: #0066ff;
        }

        .btn-embarcando.active {
            background: #0066ff;
            color: #fff;
        }

        .btn-suspendido {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border-color: #ff4444;
            grid-column: 1 / -1;
        }

        .btn-suspendido.active {
            background: #ff4444;
            color: #fff;
        }

        .vessel-actions {
            display: flex;
            gap: 12px;
        }

        .action-button {
            flex: 1;
            padding: 18px;
            border: 2px solid;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            text-align: center;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .action-button:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: all 0.3s ease;
        }

        .action-button:active:before {
            width: 300px;
            height: 300px;
        }

        .zarpar-button {
            background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
            color: #fff;
            border-color: #32CD32;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 400px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }

        .modal-title {
            color: #FFD700;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: #ff6b6b;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:active {
            background: rgba(255, 107, 107, 0.2);
            transform: scale(0.9);
        }

        .modal-body {
            margin-bottom: 25px;
        }

        .vessel-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }

        .vessel-info h3 {
            color: #FFD700;
            margin-bottom: 5px;
            font-size: 18px;
        }

        .vessel-info p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            color: #fff;
            font-size: 18px;
            text-align: center;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .modal-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .modal-input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            transform: scale(1.02);
        }

        .modal-actions {
            display: flex;
            gap: 15px;
        }

        .modal-button {
            flex: 1;
            padding: 15px;
            border: 2px solid;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }

        .modal-button:active {
            transform: scale(0.95);
        }

        .btn-cancel {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border-color: #ff6b6b;
        }

        .btn-cancel:active {
            background: #ff6b6b;
            color: #fff;
        }

        .btn-confirm {
            background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
            color: #fff;
            border-color: #32CD32;
        }

        .btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Summary Section */
        .summary-section {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .summary-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .summary-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            color: #fff;
        }

        .summary-item strong {
            color: #FFD700;
        }

        .no-selection {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            padding: 50px 20px;
            font-size: 18px;
            line-height: 1.6;
        }

        /* Bottom Safe Area */
        .safe-area-bottom {
            height: env(safe-area-inset-bottom);
            background: rgba(255, 255, 255, 0.05);
        }

        /* Loading Animation */
        .loading-vessels {
            text-align: center;
            color: #FFD700;
            padding: 50px 20px;
            font-size: 18px;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-radius: 50%;
            border-top-color: #FFD700;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Haptic Feedback Indicator */
        .haptic-feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 100px;
            background: rgba(255, 215, 0, 0.2);
            border: 3px solid #FFD700;
            border-radius: 50%;
            display: none;
            animation: pulse 0.3s ease;
            z-index: 1000;
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        /* Dark mode improvements */
        @media (prefers-color-scheme: dark) {
            .vessel-card {
                background: rgba(255, 255, 255, 0.08);
                border-color: rgba(255, 255, 255, 0.15);
            }
        }

        /* Landscape orientation adjustments */
        @media (orientation: landscape) and (max-height: 500px) {
            .login-form {
                padding: 25px 30px;
            }
            
            .login-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .mobile-header {
                padding: 15px 20px;
            }
            
            .nav-tabs {
                padding: 10px 20px;
            }
            
            .main-content {
                padding: 15px 20px;
            }

            .modal-content {
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }
        }

        /* Animation for vessel updates */
        .vessel-updating {
            animation: updatePulse 0.6s ease;
        }

        @keyframes updatePulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
            100% { transform: scale(1); }
        }

        /* Swipe indicators */
        .swipe-indicator {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        /* Enhanced touch targets */
        .touch-target {
            min-height: 44px;
            min-width: 44px;
        }
    </style>
</head>
<body>
    <!-- PWA Install Button -->
    <button class="pwa-install" id="pwaInstall"><i class="fas fa-mobile-alt"></i> Instalar App</button>

    <!-- Haptic Feedback Indicator -->
    <div class="haptic-feedback" id="hapticFeedback"></div>

    <!-- Modal para Zarpar -->
    <div class="modal-overlay" id="zarparModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-ship"></i>
                    Zarpar Embarcación
                </div>
                <button class="modal-close" id="modalClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="vessel-info" id="modalVesselInfo">
                    <h3 id="modalVesselName">Nombre de la Embarcación</h3>
                    <p>Posición en la cola</p>
                </div>

                <div class="input-group">
                    <label class="input-label" for="numPersonas">
                        <i class="fas fa-users"></i> Número de Personas
                    </label>
                    <input type="number" 
                           id="numPersonas" 
                           class="modal-input touch-target" 
                           placeholder="Ej: 8" 
                           min="1" 
                           max="50">
                </div>

                <div class="input-group">
                    <label class="input-label" for="valorViaje">
                        <i class="fas fa-dollar-sign"></i> Valor del Viaje
                    </label>
                    <input type="number" 
                           id="valorViaje" 
                           class="modal-input touch-target" 
                           placeholder="Ej: 150000" 
                           min="0" 
                           step="1000">
                </div>

                <div class="summary-section" id="summarySection" style="display: none;">
                    <div class="summary-title">Resumen del Zarpe</div>
                    <div class="summary-item">
                        <span>Personas:</span>
                        <strong id="summaryPersonas">-</strong>
                    </div>
                    <div class="summary-item">
                        <span>Valor Total:</span>
                        <strong id="summaryValor">$0</strong>
                    </div>
                    <div class="summary-item">
                        <span>Valor por Persona:</span>
                        <strong id="summaryValorPersona">$0</strong>
                    </div>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-button btn-cancel touch-target" id="btnCancelar">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button class="modal-button btn-confirm touch-target" id="btnConfirmar" disabled>
                    <i class="fas fa-check"></i> Confirmar Zarpe
                </button>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <div class="login-title">
                <i class="fas fa-cogs"></i>
                Admin Embarcaciones
            </div>
            <form id="loginForm">
                <input type="email" id="email" class="login-input touch-target" placeholder="📧 Correo electrónico" required autocomplete="email">
                <input type="password" id="password" class="login-input touch-target" placeholder="🔒 Contraseña" required autocomplete="current-password">
                <button type="submit" class="login-button touch-target" id="loginButton">Iniciar Sesión</button>
            </form>
            <div class="loading" id="loading">
                <div class="loading-spinner"></div>
                Autenticando...
            </div>
            <div class="login-error" id="loginError"></div>
        </div>
    </div>

    <!-- Main App -->
    <div class="admin-container" id="adminContainer">
        <!-- Mobile Header -->
        <div class="mobile-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="header-icon"><i class="fas fa-cogs"></i></div>
                    <div class="header-text">Admin Embarcaciones</div>
                </div>
                <button class="logout-button touch-target" id="logoutButton">Cerrar Sesión</button>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <div class="tabs-container">
                <button class="tab-button touch-target" data-category="lancha-taxi"><i class="fas fa-ship"></i> Lancha Taxi</button>
                <button class="tab-button touch-target" data-category="deportiva"><i class="fas fa-water"></i> Deportiva</button>
                <button class="tab-button touch-target" data-category="planchon"><i class="fas fa-anchor"></i> Planchón</button>
                <button class="tab-button touch-target" data-category="carguero"><i class="fas fa-shipping-fast"></i> Carguero</button>
                <button class="tab-button touch-target" data-category="barco"><i class="fas fa-sailboat"></i> Barco</button>
                <button class="tab-button touch-target" data-category="yate"><i class="fas fa-yacht"></i> Yate</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="vessels-title" id="vesselsTitle"><i class="fas fa-hand-point-up"></i> Selecciona una categoría</div>
            <div id="vesselsContent">
                <div class="no-selection">
                    <i class="fas fa-ship"></i> Toca una categoría arriba para ver las embarcaciones disponibles
                    <br><br>
                    <i class="fas fa-mobile-alt"></i> Optimizado para móvil
                </div>
            </div>
        </div>

        <!-- Safe Area Bottom -->
        <div class="safe-area-bottom"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="alerts.js"></script>
    <script type="module">
        // ===========================
        // IMPORTS DE FIREBASE
        // ===========================
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, writeBatch, addDoc } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // ===========================
        // CONFIGURACIÓN DE FIREBASE
        // ===========================
        const firebaseConfig = {
            apiKey: "AIzaSyDdjYoi4BSBFFAuXumLxj-NMQWUVSFdSv4",
            authDomain: "contratos-5e932.firebaseapp.com",
            projectId: "contratos-5e932",
            storageBucket: "contratos-5e932.firebasestorage.app",
            messagingSenderId: "945849105278",
            appId: "1:945849105278:web:f0291a411b8e33327a112f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ===========================
        // REFERENCIAS DEL DOM
        // ===========================
        const loginContainer = document.getElementById('loginContainer');
        const adminContainer = document.getElementById('adminContainer');
        const loginForm = document.getElementById('loginForm');
        const loginButton = document.getElementById('loginButton');
        const logoutButton = document.getElementById('logoutButton');
        const loading = document.getElementById('loading');
        const loginError = document.getElementById('loginError');
        const vesselsTitle = document.getElementById('vesselsTitle');
        const vesselsContent = document.getElementById('vesselsContent');
        const hapticFeedback = document.getElementById('hapticFeedback');
        const pwaInstall = document.getElementById('pwaInstall');

        // Referencias del Modal
        const zarparModal = document.getElementById('zarparModal');
        const modalClose = document.getElementById('modalClose');
        const modalVesselName = document.getElementById('modalVesselName');
        const modalVesselInfo = document.getElementById('modalVesselInfo');
        const numPersonas = document.getElementById('numPersonas');
        const valorViaje = document.getElementById('valorViaje');
        const summarySection = document.getElementById('summarySection');
        const summaryPersonas = document.getElementById('summaryPersonas');
        const summaryValor = document.getElementById('summaryValor');
        const summaryValorPersona = document.getElementById('summaryValorPersona');
        const btnCancelar = document.getElementById('btnCancelar');
        const btnConfirmar = document.getElementById('btnConfirmar');

        // ===========================
        // VARIABLES GLOBALES
        // ===========================
        let currentCategory = null;
        let embarcacionesData = {};
        let unsubscribeListener = null;
        let deferredPrompt = null;
        let currentVesselId = null;
        let currentVesselData = null;

        // ===========================
        // PWA FUNCTIONALITY
        // ===========================
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            pwaInstall.style.display = 'block';
        });

        pwaInstall.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                if (outcome === 'accepted') {
                    pwaInstall.style.display = 'none';
                }
                deferredPrompt = null;
            }
        });

        window.addEventListener('appinstalled', () => {
            pwaInstall.style.display = 'none';
        });

        // ===========================
        // HAPTIC FEEDBACK
        // ===========================
        function triggerHapticFeedback(type = 'light') {
            // Visual feedback
            hapticFeedback.style.display = 'block';
            setTimeout(() => {
                hapticFeedback.style.display = 'none';
            }, 300);

            // Haptic feedback (if supported)
            if ('vibrate' in navigator) {
                switch(type) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(20);
                        break;
                    case 'heavy':
                        navigator.vibrate([30, 10, 30]);
                        break;
                    case 'success':
                        navigator.vibrate([100, 50, 100]);
                        break;
                    case 'error':
                        navigator.vibrate([200, 100, 200, 100, 200]);
                        break;
                }
            }
        }

        // ===========================
        // CLASE TURNO NAUTICO MEJORADA
        // ===========================
        class TurnoNautico {
            constructor(lista) {
                this.lista = [...lista];
                this.reasignarPosiciones();
            }

            embarcar() {
                let embarcandoAsignado = false;
                for (const embarcacion of this.lista) {
                    if (embarcacion.estado === "SUSPENDIDO") continue;
                    if (!embarcandoAsignado) {
                        embarcacion.estado = "EMBARCANDO";
                        embarcandoAsignado = true;
                    } else {
                        embarcacion.estado = "EN TURNO";
                    }
                }
            }

            desembarcar() {
                this.embarcar();
                const index = this.lista.findIndex(e => e.estado === "EMBARCANDO");
                if (index === -1) return false;
                const embarcando = this.lista.splice(index, 1)[0];
                embarcando.estado = "EN TURNO";
                this.lista.push(embarcando);
                this.reasignarPosiciones();
                this.embarcar();
                return true;
            }

            // Nueva función para manejar embarcación suspendida en posición 1
            reactivarPrimero() {
                // Buscar embarcación en posición 1 que esté suspendida
                const primeraSuspendida = this.lista.find(e => e.posicion === 1 && e.estado === "SUSPENDIDO");
                
                if (!primeraSuspendida) {
                    return false; // No hay embarcación suspendida en posición 1
                }

                // Cambiar estado a "EN TURNO"
                primeraSuspendida.estado = "EN TURNO";

                // Reorganizar posiciones: 1->3, 2->1, 3->2
                const embarcacionPos2 = this.lista.find(e => e.posicion === 2);
                const embarcacionPos3 = this.lista.find(e => e.posicion === 3);

                // Mover la que estaba en posición 1 (suspendida) a posición 3
                primeraSuspendida.posicion = 3;

                // Mover la que estaba en posición 2 a posición 1
                if (embarcacionPos2) {
                    embarcacionPos2.posicion = 1;
                }

                // Mover la que estaba en posición 3 a posición 2
                if (embarcacionPos3) {
                    embarcacionPos3.posicion = 2;
                }

                // Ordenar la lista por posición actualizada
                this.lista.sort((a, b) => a.posicion - b.posicion);

                // Aplicar lógica de embarque
                this.embarcar();

                return true;
            }

            reasignarPosiciones() {
                this.lista.forEach((e, i) => e.posicion = i + 1);
            }

            obtenerLista() {
                return this.lista;
            }
        }

        // ===========================
        // FUNCIONES DE UI
        // ===========================
        function showError(message) {
            loginError.textContent = message;
            loginError.style.display = 'block';
            triggerHapticFeedback('error');
        }

        function hideError() {
            loginError.style.display = 'none';
        }

        function showLoading() {
            loading.style.display = 'block';
            loginButton.disabled = true;
        }

        function hideLoading() {
            loading.style.display = 'none';
            loginButton.disabled = false;
        }

        function smoothScrollToCategory() {
            const navTabs = document.querySelector('.nav-tabs');
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab && navTabs) {
                const tabRect = activeTab.getBoundingClientRect();
                const navRect = navTabs.getBoundingClientRect();
                const scrollLeft = tabRect.left - navRect.left + navTabs.scrollLeft - (navRect.width - tabRect.width) / 2;
                navTabs.scrollTo({
                    left: scrollLeft,
                    behavior: 'smooth'
                });
            }
        }

        // ===========================
        // FUNCIONES DEL MODAL
        // ===========================
        function openZarparModal(vesselId, vesselData) {
            currentVesselId = vesselId;
            currentVesselData = vesselData;
            
            modalVesselName.textContent = vesselData.nombre;
            modalVesselInfo.innerHTML = `
                <h3>${vesselData.nombre}</h3>
                <p>Posición ${vesselData.posicion} - ${vesselData.categoria}</p>
            `;
            
            // Limpiar inputs
            numPersonas.value = '';
            valorViaje.value = '';
            summarySection.style.display = 'none';
            btnConfirmar.disabled = true;
            
            zarparModal.style.display = 'flex';
            triggerHapticFeedback('medium');
            
            // Auto focus en el primer input
            setTimeout(() => {
                numPersonas.focus();
            }, 300);
        }

        function closeZarparModal() {
            zarparModal.style.display = 'none';
            currentVesselId = null;
            currentVesselData = null;
            triggerHapticFeedback('light');
        }

        function updateSummary() {
            const personas = parseInt(numPersonas.value) || 0;
            const valor = parseFloat(valorViaje.value) || 0;
            
            if (personas > 0 && valor > 0) {
                const valorPorPersona = valor / personas;
                
                summaryPersonas.textContent = personas;
                summaryValor.textContent = `${valor.toLocaleString('es-CO')}`;
                summaryValorPersona.textContent = `${Math.round(valorPorPersona).toLocaleString('es-CO')}`;
                
                summarySection.style.display = 'block';
                btnConfirmar.disabled = false;
            } else {
                summarySection.style.display = 'none';
                btnConfirmar.disabled = true;
            }
        }

        // ===========================
        // FUNCIONES DE AUTENTICACIÓN
        // ===========================
        async function login(email, password) {
            try {
                showLoading();
                hideError();
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                triggerHapticFeedback('success');
                console.log('Usuario logueado:', userCredential.user.email);
            } catch (error) {
                console.error('Error de login:', error);
                let errorMessage = 'Error al iniciar sesión';
                switch (error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'Usuario no encontrado';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Contraseña incorrecta';
                        break;
                    case 'auth/invalid-email':
                        errorMessage = 'Email inválido';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Demasiados intentos. Intenta más tarde';
                        break;
                    default:
                        errorMessage = 'Error: ' + error.message;
                }
                showError(errorMessage);
            } finally {
                hideLoading();
            }
        }

        async function logout() {
            try {
                cleanupFirebaseListener();
                await signOut(auth);
                triggerHapticFeedback('medium');
                console.log('Usuario deslogueado');
            } catch (error) {
                console.error('Error al cerrar sesión:', error);
            }
        }

        // ===========================
        // FUNCIONES DE FIREBASE
        // ===========================
        function setupFirebaseListener() {
            try {
                console.log('🔄 Configurando listener de embarcaciones...');
                const q = query(collection(db, 'embarcaciones'), where('activa', '==', true));
                unsubscribeListener = onSnapshot(q, 
                    (querySnapshot) => {
                        console.log('📡 Datos de embarcaciones actualizados');
                        embarcacionesData = {};
                        querySnapshot.forEach((doc) => {
                            const data = doc.data();
                            const categoria = data.categoria;
                            if (!embarcacionesData[categoria]) {
                                embarcacionesData[categoria] = [];
                            }
                            embarcacionesData[categoria].push({
                                id: doc.id,
                                nombre: data.nombre,
                                estado: data.estado,
                                categoria: data.categoria,
                                posicion: data.posicion || 0
                            });
                        });
                        Object.keys(embarcacionesData).forEach(categoria => {
                            embarcacionesData[categoria].sort((a, b) => a.posicion - b.posicion);
                        });
                        console.log('✅ Embarcaciones cargadas:', embarcacionesData);
                        if (currentCategory) {
                            displayVessels(currentCategory);
                        }
                    },
                    (error) => {
                        console.error('❌ Error en listener:', error);
                        if (typeof showError === 'function') {
                            showError('Error de Conexión', 'No se pudo conectar con la base de datos.', 6000);
                        }
                        triggerHapticFeedback('error');
                    }
                );
            } catch (error) {
                console.error('Error al configurar listener:', error);
                triggerHapticFeedback('error');
            }
        }

        function cleanupFirebaseListener() {
            if (unsubscribeListener) {
                console.log('🔌 Desconectando listener');
                unsubscribeListener();
                unsubscribeListener = null;
            }
        }

        // ===========================
        // FUNCIONES DE VISUALIZACIÓN
        // ===========================
        function displayVessels(categoria) {
            const categoryNames = {
                'lancha-taxi': '<i class="fas fa-ship"></i> Lancha Taxi',
                'deportiva': '<i class="fas fa-water"></i> Deportiva',
                'planchon': '<i class="fas fa-anchor"></i> Planchón',
                'carguero': '<i class="fas fa-shipping-fast"></i> Carguero',
                'barco': '<i class="fas fa-sailboat"></i> Barco',
                'yate': '<i class="fas fa-yacht"></i> Yate'
            };
            
            vesselsTitle.innerHTML = categoryNames[categoria] || categoria;
            const vessels = embarcacionesData[categoria] || [];
            
            if (vessels.length === 0) {
                vesselsContent.innerHTML = `
                    <div class="no-selection">
                        <i class="fas fa-clipboard-list"></i> No hay embarcaciones en la categoría "${categoryNames[categoria]}"
                        <br><br>
                        <i class="fas fa-sync-alt"></i> Verifica la conexión o contacta al administrador
                    </div>
                `;
                return;
            }

            let html = '';
            vessels.forEach((vessel, index) => {
                const statusClass = vessel.estado.toLowerCase().replace(' ', '-');
                const statusConfig = {
                    'EN TURNO': { icon: 'fas fa-clock', emoji: '⏳' },
                    'EMBARCANDO': { icon: 'fas fa-ship', emoji: '🚢' },
                    'SUSPENDIDO': { icon: 'fas fa-ban', emoji: '⛔' }
                };

                const config = statusConfig[vessel.estado] || { icon: 'fas fa-question', emoji: '❓' };
                
                // Determinar si se pueden cambiar todos los estados o solo a "EN TURNO"
                const esPrimeroSuspendido = vessel.posicion === 1 && vessel.estado === 'SUSPENDIDO';
                
                html += `
                    <div class="vessel-card" data-vessel-id="${vessel.id}">
                        <div class="vessel-header">
                            <div class="vessel-name">${vessel.nombre}</div>
                            <div class="vessel-position">Pos. ${vessel.posicion}</div>
                        </div>
                        
                        <div class="vessel-status">
                            <div class="current-status status-${statusClass}">
                                <i class="${config.icon}"></i> ${vessel.estado}
                            </div>
                            ${esPrimeroSuspendido ? 
                                '<div style="font-size: 12px; color: #FFD700; margin-top: 5px;"><i class="fas fa-info-circle"></i> Solo puede cambiar a "EN TURNO"</div>' : 
                                ''
                            }
                        </div>
                        
                        <div class="status-buttons">
                            <button class="status-button btn-en-turno touch-target ${vessel.estado === 'EN TURNO' ? 'active' : ''}" 
                                    onclick="updateVesselStatus('${vessel.id}', 'EN TURNO')">
                                <i class="fas fa-clock"></i> EN TURNO
                            </button>
                            ${!esPrimeroSuspendido ? `
                                <button class="status-button btn-embarcando touch-target ${vessel.estado === 'EMBARCANDO' ? 'active' : ''}" 
                                        onclick="updateVesselStatus('${vessel.id}', 'EMBARCANDO')">
                                    <i class="fas fa-ship"></i> EMBARCANDO
                                </button>
                                <button class="status-button btn-suspendido touch-target ${vessel.estado === 'SUSPENDIDO' ? 'active' : ''}" 
                                        onclick="updateVesselStatus('${vessel.id}', 'SUSPENDIDO')">
                                    <i class="fas fa-ban"></i> SUSPENDIDO
                                </button>
                            ` : `
                                <button class="status-button btn-embarcando touch-target" disabled style="opacity: 0.3;">
                                    <i class="fas fa-ship"></i> EMBARCANDO
                                </button>
                                <button class="status-button btn-suspendido touch-target active" disabled style="opacity: 0.6;">
                                    <i class="fas fa-ban"></i> SUSPENDIDO
                                </button>
                            `}
                        </div>
                        
                        <div class="vessel-actions">
                            <button class="action-button zarpar-button touch-target" 
                                    onclick="openZarparModal('${vessel.id}', ${JSON.stringify(vessel).replace(/"/g, '&quot;')})">
                                <i class="fas fa-anchor"></i> Zarpar
                            </button>
                        </div>
                    </div>
                `;
            });
            
            vesselsContent.innerHTML = html;
        }

        // ===========================
        // FUNCIONES DE ACTUALIZACIÓN
        // ===========================
        window.updateVesselStatus = async function(vesselId, newStatus) {
            try {
                console.log(`🔄 Actualizando ${vesselId} a ${newStatus}`);
                
                if (!currentCategory) {
                    triggerHapticFeedback('error');
                    if (typeof showError === 'function') {
                        showError('❌ Error de Categoría', 'No hay categoría seleccionada', 4000);
                    }
                    return;
                }

                const vesselsInCategory = embarcacionesData[currentCategory] || [];
                const vessel = vesselsInCategory.find(v => v.id === vesselId);
                
                if (!vessel) {
                    triggerHapticFeedback('error');
                    if (typeof showError === 'function') {
                        showError('❌ Error', 'Embarcación no encontrada', 4000);
                    }
                    return;
                }

                // Verificar lógica especial para embarcación suspendida en posición 1
                const esPrimeroSuspendido = vessel.posicion === 1 && vessel.estado === 'SUSPENDIDO';
                
                if (esPrimeroSuspendido && newStatus === 'EN TURNO') {
                    // Usar lógica especial de reactivación
                    const turnoManager = new TurnoNautico(vesselsInCategory);
                    const reactivacionExitosa = turnoManager.reactivarPrimero();
                    
                    if (!reactivacionExitosa) {
                        triggerHapticFeedback('error');
                        if (typeof showError === 'function') {
                            showError('❌ Error de Reactivación', 'No se pudo reactivar la embarcación', 4000);
                        }
                        return;
                    }

                    // Actualizar todas las embarcaciones afectadas en batch
                    const listaActualizada = turnoManager.obtenerLista();
                    const batch = writeBatch(db);
                    
                    listaActualizada.forEach(vesselUpdate => {
                        const vesselRef = doc(db, 'embarcaciones', vesselUpdate.id);
                        batch.update(vesselRef, {
                            estado: vesselUpdate.estado,
                            posicion: vesselUpdate.posicion,
                            fechaActualizacion: new Date()
                        });
                    });

                    await batch.commit();
                    
                    triggerHapticFeedback('success');
                    
                    if (typeof showSuccess === 'function') {
                        showSuccess('✅ Reactivación Exitosa', `${vessel.nombre} reactivada y reorganizada. Nuevas posiciones: ${vessel.nombre} (pos. 3), turnos reorganizados.`, 5000);
                    }
                    
                    console.log('✅ Reactivación y reorganización completada');
                    return;
                }

                // Lógica normal para otros casos
                // Visual feedback
                const vesselCard = document.querySelector(`[data-vessel-id="${vesselId}"]`);
                if (vesselCard) {
                    vesselCard.classList.add('vessel-updating');
                    setTimeout(() => {
                        vesselCard.classList.remove('vessel-updating');
                    }, 600);
                }
                
                triggerHapticFeedback('medium');
                
                const vesselRef = doc(db, 'embarcaciones', vesselId);
                await updateDoc(vesselRef, {
                    estado: newStatus,
                    fechaActualizacion: new Date()
                });
                
                const vesselName = vessel ? vessel.nombre : 'Embarcación';
                
                triggerHapticFeedback('success');
                
                if (typeof showSuccess === 'function') {
                    showSuccess('✅ Estado Actualizado', `${vesselName} cambió a: ${newStatus}`, 3000);
                }
                
                console.log('✅ Estado actualizado correctamente');
                
            } catch (error) {
                console.error('❌ Error al actualizar estado:', error);
                triggerHapticFeedback('error');
                
                if (typeof showError === 'function') {
                    showError('❌ Error de Actualización', 'No se pudo actualizar el estado. Intenta nuevamente.', 5000);
                }
            }
        };

        window.openZarparModal = openZarparModal;

        // ===========================
        // FUNCIÓN CONFIRMAR ZARPE - SOLO PARA CONTROLZARPES
        // ===========================
        async function confirmarZarpe() {
            if (!currentVesselId || !currentVesselData) {
                triggerHapticFeedback('error');
                return;
            }

            const personas = parseInt(numPersonas.value);
            const valor = parseFloat(valorViaje.value);

            if (!personas || !valor || personas <= 0 || valor <= 0) {
                triggerHapticFeedback('error');
                alert('Por favor complete todos los campos correctamente');
                return;
            }

            try {
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                
                triggerHapticFeedback('heavy');

                // Preparar datos para la colección ControlZarpes
                const zarpeData = {
                    fechaHora: new Date(),
                    embarcacion: currentVesselData.nombre,
                    posicionDesembarque: currentVesselData.posicion,
                    cantidadPasajeros: personas,
                    valorTotal: valor,
                    // Campos adicionales útiles para el control
                    categoria: currentVesselData.categoria,
                    embarcacionId: currentVesselId,
                    valorPorPersona: Math.round(valor / personas),
                    administrador: auth.currentUser?.email || 'admin'
                };

                // Guardar registro del zarpe en ControlZarpes
                await addDoc(collection(db, 'ControlZarpes'), zarpeData);

                // Realizar desembarque y reorganización de embarcaciones
                const vesselsInCategory = embarcacionesData[currentCategory] || [];
                const turnoManager = new TurnoNautico(vesselsInCategory);
                const desembarqueExitoso = turnoManager.desembarcar();

                if (desembarqueExitoso) {
                    const listaActualizada = turnoManager.obtenerLista();
                    const batch = writeBatch(db);
                    
                    listaActualizada.forEach(vessel => {
                        const vesselRef = doc(db, 'embarcaciones', vessel.id);
                        batch.update(vesselRef, {
                            estado: vessel.estado,
                            posicion: vessel.posicion,
                            fechaActualizacion: new Date()
                        });
                    });

                    await batch.commit();
                }

                triggerHapticFeedback('success');
                
                if (typeof showSuccess === 'function') {
                    showSuccess('⚓ Zarpe Exitoso', 
                            `${currentVesselData.nombre} zarpó con ${personas} personas por ${valor.toLocaleString('es-CO')}`, 
                            5000);
                }

                closeZarparModal();
                
                console.log('✅ Zarpe registrado exitosamente en ControlZarpes:', zarpeData);

            } catch (error) {
                console.error('❌ Error al confirmar zarpe:', error);
                
                // Manejo específico de errores de Firebase
                if (error.code === 'permission-denied') {
                    triggerHapticFeedback('error');
                    if (typeof showError === 'function') {
                        showError('❌ Permisos Insuficientes', 
                                'No tiene permisos para registrar zarpes en ControlZarpes. Contacte al administrador del sistema.', 
                                8000);
                    }
                    return;
                }
                
                triggerHapticFeedback('error');
                
                if (typeof showError === 'function') {
                    showError('❌ Error en Zarpe', 
                            `Error: ${error.message}. Intente nuevamente.`, 
                            5000);
                }
            } finally {
                btnConfirmar.disabled = false;
                btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Zarpe';
            }
        }
        // ===========================
        // EVENT LISTENERS
        // ===========================
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            login(email, password);
        });

        logoutButton.addEventListener('click', () => {
            if (confirm('¿Estás seguro de que quieres cerrar sesión?')) {
                logout();
            }
        });

        // Modal event listeners
        modalClose.addEventListener('click', closeZarparModal);
        btnCancelar.addEventListener('click', closeZarparModal);
        btnConfirmar.addEventListener('click', confirmarZarpe);

        // Input event listeners para actualizar resumen
        numPersonas.addEventListener('input', updateSummary);
        valorViaje.addEventListener('input', updateSummary);

        // Cerrar modal al hacer clic fuera
        zarparModal.addEventListener('click', (e) => {
            if (e.target === zarparModal) {
                closeZarparModal();
            }
        });

        // Prevenir cierre accidental del modal
        document.querySelector('.modal-content').addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Tecla Escape para cerrar modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && zarparModal.style.display === 'flex') {
                closeZarparModal();
            }
        });

        // Tab buttons functionality
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('tab-button')) {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked tab
                e.target.classList.add('active');
                
                // Get category and display vessels
                const categoria = e.target.getAttribute('data-category');
                currentCategory = categoria;
                
                triggerHapticFeedback('light');
                
                // Smooth scroll to center the active tab
                setTimeout(smoothScrollToCategory, 100);
                
                displayVessels(categoria);
            }
        });

        // ===========================
        // MOBILE OPTIMIZATIONS
        // ===========================
        
        // Prevent zoom on input focus (iOS)
        document.addEventListener('touchstart', function() {}, {passive: true});
        
        // Handle orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                smoothScrollToCategory();
            }, 100);
        });
        
        // Prevent pull-to-refresh
        document.body.addEventListener('touchstart', (e) => {
            if (e.touches.length !== 1) return;
            const startY = e.touches[0].pageY;
            let element = e.target;  // Cambio de const a let
            
            while (element && element !== document.body) {
                if (element.scrollTop > 0) return;
                element = element.parentElement;  // Ahora esta asignación es válida
            }
            
            if (startY <= 10) {
                e.preventDefault();
            }
        }, {passive: false});
        
        document.body.addEventListener('touchmove', (e) => {
            const element = e.target;
            let scrollable = false;
            
            while (element && element !== document.body) {
                if (element.scrollHeight > element.clientHeight) {
                    scrollable = true;
                    break;
                }
                element = element.parentElement;
            }
            
            if (!scrollable) {
                e.preventDefault();
            }
        }, {passive: false});

        // ===========================
        // OBSERVER DE AUTENTICACIÓN
        // ===========================
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('✅ Usuario autenticado:', user.email);
                loginContainer.style.display = 'none';
                adminContainer.style.display = 'flex';
                setupFirebaseListener();
                
                if (typeof showSuccess === 'function') {
                    showSuccess('✅ Sesión Iniciada', `Bienvenido ${user.email}`, 3000);
                }
                
                triggerHapticFeedback('success');
                
            } else {
                console.log('❌ Usuario no autenticado');
                cleanupFirebaseListener();
                loginContainer.style.display = 'flex';
                adminContainer.style.display = 'none';
                
                // Reset form
                document.getElementById('email').value = '';
                document.getElementById('password').value = '';
                hideError();
                hideLoading();
                
                // Reset state
                currentCategory = null;
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                vesselsTitle.innerHTML = '<i class="fas fa-hand-point-up"></i> Selecciona una categoría';
                vesselsContent.innerHTML = `
                    <div class="no-selection">
                        <i class="fas fa-ship"></i> Toca una categoría arriba para ver las embarcaciones disponibles
                        <br><br>
                        <i class="fas fa-mobile-alt"></i> Optimizado para móvil
                    </div>
                `;
                
                // Cerrar modal si está abierto
                closeZarparModal();
                
                if (typeof clearAllAlerts === 'function') {
                    clearAllAlerts();
                }
            }
        });

        // ===========================
        // MANEJO DE ERRORES DE RED
        // ===========================
        window.addEventListener('online', () => {
            triggerHapticFeedback('success');
            if (typeof showSuccess === 'function') {
                showSuccess('🌐 Conexión Restaurada', 'La aplicación está nuevamente en línea', 3000);
            }
        });

        window.addEventListener('offline', () => {
            triggerHapticFeedback('error');
            if (typeof showWarning === 'function') {
                showWarning('📶 Sin Conexión', 'Verifica tu conexión a internet. Algunas funciones pueden no estar disponibles.', 5000);
            }
        });

        // ===========================
        // AUTO-LOGOUT EN RECARGA
        // ===========================
        window.addEventListener('beforeunload', () => {
            if (auth.currentUser) {
                signOut(auth);
            }
        });

        window.addEventListener('load', () => {
            if (auth.currentUser) {
                signOut(auth);
            }
        });

        // ===========================
        // SERVICE WORKER (PWA)
        // ===========================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }

        // ===========================
        // PERFORMANCE MONITORING
        // ===========================
        function measurePerformance(operationName, startTime) {
            const endTime = performance.now();
            const duration = endTime - startTime;
            console.log(`⏱️ ${operationName}: ${duration.toFixed(2)}ms`);
            
            // Si la operación toma más de 2 segundos, mostrar feedback
            if (duration > 2000) {
                if (typeof showWarning === 'function') {
                    showWarning('⚠️ Operación Lenta', 'La operación tomó más tiempo del esperado. Verifica tu conexión.', 4000);
                }
            }
        }

        // ===========================
        // DEBUGGING Y LOGS
        // ===========================
        function logUserAction(action, details = {}) {
            const timestamp = new Date().toISOString();
            const logEntry = {
                timestamp,
                action,
                user: auth.currentUser?.email || 'anonymous',
                category: currentCategory,
                ...details
            };
            console.log('📊 User Action:', logEntry);
        }

        // ===========================
        // VALIDACIONES ADICIONALES
        // ===========================
        
        // Validación de números en inputs
        numPersonas.addEventListener('input', (e) => {
            let value = parseInt(e.target.value);
            if (value < 1) e.target.value = '';
            if (value > 50) e.target.value = 50;
        });

        valorViaje.addEventListener('input', (e) => {
            let value = parseFloat(e.target.value);
            if (value < 0) e.target.value = '';
            if (value > 10000000) e.target.value = 10000000; // Límite de 10 millones
        });

        // Formateo automático del valor
        valorViaje.addEventListener('blur', (e) => {
            const value = parseFloat(e.target.value);
            if (value) {
                e.target.value = Math.round(value);
            }
        });

        // ===========================
        // INICIALIZACIÓN
        // ===========================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🚀 Aplicación móvil de administración inicializada con modal de zarpe');
            
            // iOS Safari viewport fix
            const setViewportHeight = () => {
                const vh = window.innerHeight * 0.01;
                document.documentElement.style.setProperty('--vh', `${vh}px`);
            };
            
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight);
            window.addEventListener('orientationchange', setViewportHeight);
            
            // Log inicial
            logUserAction('app_initialized', {
                userAgent: navigator.userAgent,
                viewport: `${window.innerWidth}x${window.innerHeight}`,
                online: navigator.onLine,
                features: ['zarpe_modal', 'haptic_feedback', 'pwa_support']
            });
        });

    </script>
</body>
</html>
